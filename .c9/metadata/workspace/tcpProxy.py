{"changed":true,"filter":false,"title":"tcpProxy.py","tooltip":"/tcpProxy.py","value":"import sys\nimport socket\nimport threading\n\ndef server_loop(local_host, local_port, remote_host, remote_port, receive_first):\n\n    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n\n    try:\n        server.bind((local_host, local_port))\n    except:\n            print\"[!!] Failed to listen on: %s:%d\" % (local_host,\n            local_port)\n            print\"[!!] Check for other listening sockets or correct permissions.\"\n            sys.exit(0)\n            print \"[*] Listening on %s:%d\" % (local_host, local_port)\n\n            server.listen(5)\n\n            while True:\n                client_socket, addr = server.accept()\n\n                #print out the local conn\n                print \"[==>] Received incoming connection from %s:%d\" %\n                (addr[0], addr[1])\n\n                #start thread for remote host\n                proxy_thread = threading.Thread(target=proxy_handler,\n                args= (client_socket,remote_host,remote_port,receive_first))\n\n                proxy_thread.start()\n\ndef proxy_handler(client_socket, remote_host, remote_port, receive_first):\n\n    #connect to remote\n    remote_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n    remote_socket.connect((remote_host, remoteport))\n\n    #recv data from remote\n    if receive_first:\n\n            remote_buffer = receive_from(remote_socket)\n            hexdump(remote_buffer)\n\n            #send to response handler\n            remote_buffer = response_handler(remote_buffer)\n\n            if len (remote_buffer):\n                print \"[<==] Sending %d bytes to local.\" % len(remote_buffer)\n                client_socket.send(remote_buffer)\n\n\n\n\n    while True:\n            #read from local\n            local_buffer = receive_from(client_socket)\n\n            if len(local_buffer):\n\n                print\"[==>] Received %d bytes from local.\" len(local_buffer)\n                hexdump(local_buffer)\n            \n                local_buffer = request_handler(local_buffer)\n                \n                remote_socket.send(local_buffer)\n                print \"[==>] Sent to remote.\"\n                \n                remote_buffer = receive_from(remote_socket)\n                \n            if len(remote_buffer):\n                print \"[<==] Received %d from remote.\" % len(remote_buffer)\n                hexdump(remote_buffer)\n                \n                remote_buffer = response_handler(remote_buffer)\n                \n                client_socket.send(remote_buffer)\n                \n                print\"[<==] sent to local.\"\n            #check for lack of data and close\n            if not len(local_buffer) or not len(remote_buffer):\n                client_socket.close()\n                remote_socket.close()\n                print\"No more datas. All connections closed.\"\n                \n                break\n\ndef hexdump(src, length=16):\n    result = []\n    digits = 4 if isinstance(src, unicode) else 2\n    \n    for i in xrange(0, len(src), length):\n        s = src[i:i+length]\n        hexa = b ' '.join([\"%0*X\" % (digits, ord(x)) for x in s])\n        text = b''.join([x if 0x20 <= ord(x) <0x7F else b '.' for x in s])\n        result.append(b\"%04X %-*s %s\" % (i,length*(digits + 1), hexa, text))\n    print b'\\n'.join(result)\n    \ndef receive_from(connection):\n    \n    buffer = \"\"\n    \n    #set 2 second timeout depending on target adjust as needed.\n    connection.settimeout(2)\n    \n        try:\n            #read into buffer until done\n            while True:\n                data = connection.recv(4096)\n                \n                if not data:\n                    break\n                buffer += data\n                \n        except:\n        pass\n        return buffer\n\ndef request_handler(buffer):\n    #|*****************************************|\n    #|Welcome to the packet manipulation ZONE! |\n    #|*****************************************|\n    \n    return buffer\n                \ndef response_handler(buffer):\n    #|*****************************************|\n    #|Welcome to the packet manipulation ZONE! |\n    #|*****************************************|\n    return buffer\n\ndef main():\n    #[1:] everything after script name up to 5 args\n    if len(sys.argv[1:]) != 5:\n        print \"\"\"Usage: ./tcpProxy.py [localhost] [localport] [remotehost]\n        [remote port] [receive_first]\"\"\"\n        print \"Example: ./tcpProxy.py 127.0.0.1 1337 10.12.132.1 1337 True\"\n        sys.exit(0)\n\n    #set up local listening port\n    local_host = sys.argv[1]\n    local_port = int(sys.argv[2])\n\n    #remote target\n    remote_host = sys.argv[3]\n    remote_port = int(sys.argv[4])\n\n    #tell proxy to connect and recv\n    #before sending to remote\n    receive_first = sys.argv[5]\n\n    if \"True\" in receive_first:\n        receive_first = True\n    else:\n        receive_first = False\n\n    #turn up listener\n    server_loop(local_host,local_port,remote_host,remote_port,receive_first)\n\nmain()\n","undoManager":{"mark":-1628,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":121,"column":12},"end":{"row":121,"column":13},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":11},"end":{"row":121,"column":12},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":10},"end":{"row":121,"column":11},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":9},"end":{"row":121,"column":10},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":8},"end":{"row":121,"column":9},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":7},"end":{"row":121,"column":8},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":6},"end":{"row":121,"column":7},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":5},"end":{"row":121,"column":6},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":5},"end":{"row":121,"column":6},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":6},"end":{"row":121,"column":7},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":7},"end":{"row":121,"column":8},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":8},"end":{"row":121,"column":9},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":9},"end":{"row":121,"column":10},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":10},"end":{"row":121,"column":11},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":11},"end":{"row":121,"column":12},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":12},"end":{"row":121,"column":13},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":13},"end":{"row":121,"column":14},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":14},"end":{"row":121,"column":15},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":15},"end":{"row":121,"column":16},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":16},"end":{"row":121,"column":17},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":17},"end":{"row":121,"column":18},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":18},"end":{"row":121,"column":19},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":19},"end":{"row":121,"column":20},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":20},"end":{"row":121,"column":21},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":21},"end":{"row":121,"column":22},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":22},"end":{"row":121,"column":23},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":23},"end":{"row":121,"column":24},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":24},"end":{"row":121,"column":25},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":25},"end":{"row":121,"column":26},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":26},"end":{"row":121,"column":27},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":27},"end":{"row":121,"column":28},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":28},"end":{"row":121,"column":29},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":29},"end":{"row":121,"column":30},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":30},"end":{"row":121,"column":31},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":31},"end":{"row":121,"column":32},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":32},"end":{"row":121,"column":33},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":33},"end":{"row":121,"column":34},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":34},"end":{"row":121,"column":35},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":35},"end":{"row":121,"column":36},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":36},"end":{"row":121,"column":37},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":37},"end":{"row":121,"column":38},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":38},"end":{"row":121,"column":39},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":39},"end":{"row":121,"column":40},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":40},"end":{"row":121,"column":41},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":41},"end":{"row":121,"column":42},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":42},"end":{"row":121,"column":43},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":43},"end":{"row":121,"column":44},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":44},"end":{"row":121,"column":45},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":45},"end":{"row":121,"column":46},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":121,"column":46},"end":{"row":121,"column":47},"action":"insert","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":124,"column":16},"end":{"row":125,"column":0},"action":"insert","lines":["",""]},{"start":{"row":125,"column":0},"end":{"row":125,"column":16},"action":"insert","lines":["                "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":12},"end":{"row":125,"column":16},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":8},"end":{"row":125,"column":12},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":4},"end":{"row":125,"column":8},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":0},"end":{"row":125,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":0},"end":{"row":125,"column":1},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":1},"end":{"row":125,"column":2},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":2},"end":{"row":125,"column":3},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":3},"end":{"row":125,"column":4},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":4},"end":{"row":125,"column":5},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":5},"end":{"row":125,"column":6},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":6},"end":{"row":125,"column":7},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":7},"end":{"row":125,"column":8},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":8},"end":{"row":125,"column":9},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":4},"end":{"row":125,"column":9},"action":"remove","lines":["respo"]},{"start":{"row":125,"column":4},"end":{"row":125,"column":20},"action":"insert","lines":["response_handler"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":20},"end":{"row":125,"column":21},"action":"insert","lines":["("]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":21},"end":{"row":125,"column":22},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":22},"end":{"row":125,"column":23},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":23},"end":{"row":125,"column":24},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":24},"end":{"row":125,"column":25},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":25},"end":{"row":125,"column":26},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":26},"end":{"row":125,"column":27},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":27},"end":{"row":125,"column":28},"action":"insert","lines":[")"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":28},"end":{"row":125,"column":29},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":125,"column":29},"end":{"row":126,"column":0},"action":"insert","lines":["",""]},{"start":{"row":126,"column":0},"end":{"row":126,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":4},"end":{"row":127,"column":0},"action":"insert","lines":["",""]},{"start":{"row":127,"column":0},"end":{"row":127,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":4},"end":{"row":127,"column":5},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":5},"end":{"row":127,"column":6},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":6},"end":{"row":127,"column":7},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":7},"end":{"row":127,"column":8},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":8},"end":{"row":127,"column":9},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":9},"end":{"row":127,"column":10},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":10},"end":{"row":127,"column":11},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":11},"end":{"row":127,"column":12},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":12},"end":{"row":127,"column":13},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":13},"end":{"row":127,"column":14},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":14},"end":{"row":127,"column":15},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":15},"end":{"row":127,"column":16},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":16},"end":{"row":127,"column":17},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":4},"end":{"row":128,"column":47},"action":"insert","lines":["#******************************************","    #Welcome to the packet manipulation ZONE! |","    #******************************************"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":5},"end":{"row":127,"column":6},"action":"insert","lines":["\\"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":5},"end":{"row":127,"column":6},"action":"remove","lines":["\\"]}]}],[{"group":"doc","deltas":[{"start":{"row":127,"column":5},"end":{"row":127,"column":6},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":5},"end":{"row":126,"column":6},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":128,"column":5},"end":{"row":128,"column":6},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":128,"column":47},"end":{"row":128,"column":48},"action":"remove","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":128,"column":47},"end":{"row":128,"column":48},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":47},"end":{"row":126,"column":48},"action":"remove","lines":["*"]}]}],[{"group":"doc","deltas":[{"start":{"row":126,"column":47},"end":{"row":126,"column":48},"action":"insert","lines":["|"]}]}],[{"group":"doc","deltas":[{"start":{"row":119,"column":4},"end":{"row":121,"column":47},"action":"remove","lines":["#******************************************","    #Welcome to the packet manipulation ZONE! |","    #******************************************"]},{"start":{"row":119,"column":4},"end":{"row":121,"column":48},"action":"insert","lines":[" #|*****************************************|","    #|Welcome to the packet manipulation ZONE! |","    #|*****************************************|"]}]}],[{"group":"doc","deltas":[{"start":{"row":119,"column":4},"end":{"row":119,"column":5},"action":"remove","lines":[" "]}]}]]},"ace":{"folds":[],"customSyntax":"python","scrolltop":1358.5,"scrollleft":0,"selection":{"start":{"row":131,"column":11},"end":{"row":131,"column":11},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1419631337000}